! Command: show running-config
! device: VM2 (vEOS, EOS-4.31.2F-cloud)
!
! boot system flash:/CloudEOS-4.31.2F.swi
!
aaa root secret sha512 $6$TmBZtLmYicAAepRs$DGlkk7LD3fW69y75JyQrieR8gE5GY505NF2jrPYZL7xzdwII/1j2YSMXomjT1fBo9Yhl/IF7vJr4D6l6aRvmd/
!
username admin privilege 15 role network-admin secret sha512 $6$IkEduSxLc9c2oGnS$5LrfLY.qi60E.klMyjqykMkMyABHe8nrNTYL/HsMjkGf1RDo61HpRdWGkqYDlItcZIN58H/0Me9cEtR51E54O/
username matt privilege 15 secret sha512 $6$vLXh5m3FC7SVriTv$208b/bEiN3EL145GeIp3MxgWSED3BgeiT1Ct1d74bh1E3Xv8uoLT2FZXeELv/eMyg6KoLRG2uj4jGmjQ1H8nt0
!
switchport default mode routed
!
load-interval default 1
!
transceiver qsfp default-mode 4x10G
!
service routing protocols model multi-agent
!
hostname VM2
!
router path-selection
   path-group VZ_OFF
      ipsec profile AUTOVPNTUNNEL
      !
      local interface Ethernet1
         stun server-profile profile1 profile2
      !
      peer dynamic
      !
      peer static router-ip 10.255.255.1
         ipv4 address 172.16.0.4
      !
      peer static router-ip 10.255.255.4
         ipv4 address 172.16.0.7
   !
   load-balance policy LBPOLICY
      path-group VZ_OFF
   !
   policy USAA_POLICY
      default-match
         load-balance LBPOLICY
   !
   policy dps-policy-default
      default-match
         load-balance LBPOLICY
   !
   vrf USAA
      path-selection-policy USAA_POLICY
   !
   vrf default
      path-selection-policy dps-policy-default
!
platform sfe data-plane cpu allocation maximum 4
!
spanning-tree mode none
!
system l1
   unsupported speed action error
   unsupported error-correction action error
!
vrf instance MGMT
!
vrf instance USAA
!
management api http-commands
   no shutdown
   !
   vrf MGMT
      no shutdown
!
aaa authorization exec default local
!
ip security
   ike policy IKEAUTOVPN
      local-id 10.255.255.12
   !
   sa policy SAAUTOVPN
   !
   profile AUTOVPNTUNNEL
      ike-policy IKEAUTOVPN 
      sa-policy SAAUTOVPN 
      connection start
      shared-key 7 045A190F1C354D
      dpd 2 10 clear
      mode transport
   !
   key controller
      profile AUTOVPNTUNNEL
!
interface Dps1
!
interface Ethernet1
   description VZ_OFF
   mtu 9000
   no switchport
   ip address 172.16.0.11/31
!
interface Ethernet2
   description CE_interface
   no switchport
   vrf USAA
   ip address 10.6.255.2/31
   ip ospf network point-to-point
!
interface Loopback0
   ip address 10.255.255.12/32
!
interface Management1
   vrf MGMT
   ip address 172.28.138.241/20
!
interface Vxlan1
   vxlan source-interface Loopback0
   vxlan udp-port 4789
   vxlan vrf USAA vni 201
   vxlan vrf default vni 101
!
ip routing
ip routing vrf MGMT
ip routing vrf USAA
!
ip extcommunity-list SITE-OF-ORIGIN permit soo 65000:6
!
ip route 0.0.0.0/0 172.16.0.10
ip route vrf MGMT 0.0.0.0/0 172.28.128.1
!
route-map DENY-SOO deny 10
   match extcommunity SITE-OF-ORIGIN
!
route-map DENY-SOO permit 20
!
route-map MATCH_TAG deny 10
   match tag 10
!
route-map MATCH_TAG permit 20
   set extcommunity soo 65000:6
!
route-map PERMIT_ALL permit 10
!
route-map SET_SOO permit 10
   set extcommunity soo 65000:6 additive
!
route-map SET_TAG permit 10
   set tag 10
!
router bgp 65000
   router-id 10.255.255.12
   distance bgp 20 20 20
   maximum-paths 16
   neighbor PATHFINDER peer group
   neighbor PATHFINDER remote-as 65000
   neighbor PATHFINDER update-source Loopback0
   neighbor PATHFINDER bfd
   neighbor PATHFINDER bfd interval 1000 min-rx 1000 multiplier 3
   neighbor PATHFINDER send-community
   neighbor PATHFINDER maximum-routes 12000
   neighbor 10.255.255.1 peer group PATHFINDER
   neighbor 10.255.255.4 peer group PATHFINDER
   !
   address-family evpn
      neighbor PATHFINDER activate
      neighbor PATHFINDER route-map DENY-SOO in
   !
   address-family ipv4
      no neighbor PATHFINDER activate
   !
   address-family path-selection
      neighbor PATHFINDER activate
      neighbor PATHFINDER additional-paths receive
      neighbor PATHFINDER additional-paths send any
   !
   vrf USAA
      rd 10.255.255.12:1
      route-target import evpn 65000:1
      route-target export evpn 65000:1
      redistribute connected
      redistribute ospf route-map MATCH_TAG
      redistribute static
!
router ospf 1 vrf USAA
   router-id 10.255.255.12
   redistribute bgp route-map SET_TAG
   network 10.6.255.2/32 area 0.0.0.0
   max-lsa 12000
   no default-information originate
!
stun
   client
      server-profile profile1
         ip address 172.16.0.4
      !
      server-profile profile2
         ip address 172.16.0.7
!
end
