! Command: show running-config
! device: ind356 (AWE-5510, EOS-4.32.0F-35901106.sambathpolicybasedvpneft0 (engineering build))
!
! boot system flash:/EOS-policy.swi
!
aaa root secret sha512 $6$sUlGHdWRFnJi4LYg$XN0MPOAiHWV9iN6iu3L/Wo/PPJJNsXRB1YgzogCNsr7EoHAssVCSrNoqYG8WS1swFuT5dPG8bTjlLMt6m8nmU0
aaa authentication policy local allow-nopassword-remote-login
!
username admin privilege 15 role network-admin nopassword
username matt privilege 15 secret sha512 $6$NB8lA6WD4JpKa9hP$P44JWicJlpxJ2uVG1bJryf4xtQhkl2fSryT7JuBkCLnUN0c/0tG7uX10DjN6SjluhiXqs86LDgSNJr79vYJJx/
!
prompt %H.%D{%H:%M:%S}%P
alias cc clear counters
alias cp clear platform trident counters
alias senz show interface counter error | nz
alias shmc show int | awk '/^[A-Z]/ { intf = tg267 } /, address is/ { print intf, }'
alias snz show interface counter | nz
alias sqnz show interface counter queue | nz
alias srnz show interface counter rate | nz
!
transceiver qsfp default-mode 4x10G
!
service routing protocols model multi-agent
!
hostname ind356
ip name-server vrf default 172.22.60.20
dns domain sjc.aristanetworks.com
!
router path-selection
   peer dynamic source stun
   !
   path-group ATT
      ipsec profile AUTOVPNTUNNEL
      !
      local interface Ethernet1/1
         stun server-profile profile1
      !
      peer static router-ip 10.255.255.3
         ipv4 address 172.16.2.5
   !
   path-group INET
      ipsec profile AUTOVPNTUNNEL
      !
      local interface Ethernet1/2
   !
   load-balance policy LBPOLICY
      path-group ATT
      path-group INET
   !
   policy USAA_POLICY
      default-match
         load-balance LBPOLICY
   !
   policy dps-policy-default
      default-match
         load-balance LBPOLICY
   !
   vrf USAA
      path-selection-policy USAA_POLICY
   !
   vrf default
      path-selection-policy dps-policy-default
!
snmp-server community public ro
!
spanning-tree mode mstp
!
system l1
   unsupported speed action error
   unsupported error-correction action error
!
clock timezone US/Pacific
!
vrf instance USAA
!
management api http-commands
   no shutdown
!
aaa authorization exec default local
!
ip security
   ike policy IKEAUTOVPN
      local-id 10.255.255.2
   !
   sa policy SAAUTOVPN
   !
   profile AUTOVPNTUNNEL
      ike-policy IKEAUTOVPN 
      sa-policy SAAUTOVPN 
      connection start
      shared-key 7 0207165218120E
      dpd 2 10 clear
      mode transport
   !
   key controller
      profile AUTOVPNTUNNEL
!
interface Dps1
!
interface Ethernet1/1
   description ATT
   mtu 9000
   no switchport
   ip address 172.16.2.0/31
!
interface Ethernet1/2
   description INET
   mtu 1500
   no switchport
   ip address 172.16.3.1/31
!
interface Ethernet1/3
   no switchport
   vrf USAA
   ip address 10.1.255.2/31
   ip ospf network point-to-point
!
interface Ethernet1/4
   mtu 9000
   no switchport
   vrf USAA
   ip address 172.16.255.2/31
!
interface Ethernet1/5
!
interface Ethernet1/6
!
interface Ethernet1/7
!
interface Ethernet1/8
!
interface Ethernet1/9
!
interface Ethernet1/10
!
interface Ethernet1/11
!
interface Ethernet1/12
!
interface Ethernet1/13
!
interface Ethernet1/14
!
interface Ethernet1/15
!
interface Ethernet1/16
!
interface Loopback0
   ip address 10.255.255.2/32
!
interface Management1/1
   ip address 172.28.137.227/20
!
interface Vxlan1
   vxlan source-interface Loopback0
   vxlan udp-port 4789
   vxlan vrf USAA vni 201
   vxlan vrf default vni 101
!
ip routing
ip routing vrf USAA
!
ip prefix-list LOCAL seq 10 permit 0.0.0.0/0
ip community-list EDGE permit 1:2
ip community-list TRANSIT permit 1:1
ip extcommunity-list SITE-OF-ORIGIN permit soo 65000:1
ip extcommunity-list color10 permit color 10
!
ip route 10.80.0.0/12 172.28.128.1
ip route 10.239.0.0/16 172.28.128.1
ip route 10.240.0.0/13 172.28.128.1
ip route 172.16.0.0/12 172.28.128.1
ip route 172.16.2.0/24 172.16.2.1
ip route 172.16.3.0/24 172.16.3.0
!
ntp server 172.22.60.22
!
route-map DENY-SOO deny 10
   match extcommunity SITE-OF-ORIGIN
!
route-map DENY-SOO permit 20
!
route-map LOWER_LP deny 1
   match extcommunity color10
!
route-map LOWER_LP deny 2
   match extcommunity SITE-OF-ORIGIN
!
route-map LOWER_LP permit 10
   set extcommunity color 10 additive
   set local-preference 5
!
route-map MATCH_TAG deny 10
   match tag 10
!
route-map MATCH_TAG permit 20
   set extcommunity soo 65000:1 additive
!
route-map SET_COMMUNITY_TRANSIT deny 5
   match extcommunity SITE-OF-ORIGIN
!
route-map SET_COMMUNITY_TRANSIT permit 10
   set community 1:1
!
route-map SET_COMM_EDGE deny 5
   match extcommunity SITE-OF-ORIGIN
!
route-map SET_COMM_EDGE permit 10
   set community 1:2
!
route-map SET_TAG permit 10
   set tag 10
!
router bgp 65000
   router-id 10.255.255.2
   distance bgp 20 20 20
   maximum-paths 16
   bgp listen range 10.255.0.0/16 peer-group autovpnEdges remote-as 65000
   neighbor autovpnEdges peer group
   neighbor autovpnEdges remote-as 65000
   neighbor autovpnEdges update-source Loopback0
   neighbor autovpnEdges bfd
   neighbor autovpnEdges bfd interval 1000 min-rx 1000 multiplier 3
   neighbor autovpnEdges ebgp-multihop
   neighbor autovpnEdges route-reflector-client
   neighbor autovpnEdges send-community extended
   neighbor autovpnEdges maximum-routes 12000
   neighbor 10.255.255.3 peer group autovpnEdges
   neighbor 10.255.255.4 peer group autovpnEdges
   !
   address-family evpn
      neighbor autovpnEdges activate
      neighbor autovpnEdges route-map SET_COMM_EDGE in
   !
   address-family ipv4
      no neighbor autovpnEdges activate
   !
   address-family path-selection
      bgp additional-paths receive
      bgp additional-paths send any
      neighbor autovpnEdges activate
      neighbor autovpnEdges additional-paths receive
      neighbor autovpnEdges additional-paths send any
   !
   vrf USAA
      rd 10.255.255.2:1
      route-target import evpn 65000:1
      route-target export evpn 65000:1
      neighbor 172.16.255.3 remote-as 65000
      neighbor 172.16.255.3 next-hop-self
      neighbor 172.16.255.3 route-reflector-client
      neighbor 172.16.255.3 route-map LOWER_LP out
      neighbor 172.16.255.3 send-community
      redistribute connected
      redistribute ospf route-map MATCH_TAG
      redistribute static
!
router general
   control-functions
      code
                        
                           function NH_LOC() {
                           if community match community_list TRANSIT {
                              next_hop = 10.255.255.2;
                              local_preference=10;
                           } 
                           return true;
                        }
                        
                          function NH_LOC2() {
                           if community match community_list EDGE {
                              next_hop = 10.255.255.2;
                               local_preference=20;
                           } 
                           return true;
                        }
      EOF
!
router ospf 1 vrf USAA
   router-id 10.255.255.2
   redistribute bgp route-map SET_TAG
   network 10.1.255.2/32 area 0.0.0.0
   network 10.5.255.0/32 area 0.0.0.0
   max-lsa 12000
!
stun
   client
      server-profile PEER
         ip address 172.16.255.3
      !
      server-profile profile1
         ip address 172.16.2.5
   !
   server
      local-interface Ethernet1/1
      local-interface Ethernet1/2
      local-interface Ethernet1/4
      binding timeout 40 seconds
!
end
